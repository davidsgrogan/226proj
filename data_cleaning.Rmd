---
output:
  html_notebook: default
---

```{r}
library(baseballDBR)
library(Lahman)
library(tidyverse)
library(GGally)
```

```{r}
#BattingPost <- filter(Lahman::BattingPost, playerID=="ripkeca01" | playerID=="anderbr01")

selected_postseason <- select(BattingPost, -c(round, teamID, lgID))
grouped_postseason <- group_by(selected_postseason, yearID, playerID)
summarized_postseason <- summarize_all(grouped_postseason, sum)
nrow(summarized_postseason)
```
There are `r nrow(summarized_postseason)` player-year rows in postseason after collapsing a player's multiple postseason series into 1 row.

Now let's see how prevalent NA is in the postseason.

```{r}
nrow(summarized_postseason %>% na.omit())
```
So we only lose 201 rows if we throw out all the rows with na. But we could be biasing if certain types of players have NAs when other players don't.

```{r}
summarise_all(summarized_postseason, funs(mean(is.na(.))))
```

Only 1884 -> 1892 have NAs, which are for CS, HBP, SH, SF, GIDP. 1903 and forward are complete. Which is same as na.omit() above.

```{r}
summarized_postseason <- na.omit(summarized_postseason)
```

Now to figure out regular season.

```{r}
nrow(Batting)
```

How are traded players represented? Willie Mays was traded once midseason.
```{r}
mays <- filter(Lahman::Batting, playerID=="mayswi01", yearID > 1970)
mays
```

The player is only going to play in the postseason for his last team/league (right?), so let's
only keep last stint, throw out the rest.

```{r}
group_by(mays, playerID, yearID) %>% filter(stint == max(stint))
```

Now apply that to the whole Batting table and ensure there is only one row per player-year.
```{r}
Batting <- group_by(Lahman::Batting, playerID, yearID)
nrow(Batting)
only_last_stint <- Batting %>% filter(stint == max(stint))
nrow(only_last_stint)
Batting_with_rows <- summarize(Batting, rows = n())
nrow(Batting_with_rows)
# They both equal 95250, so this works.
```

```{r}
# It's IBB that we don't have data for. Which is unfortunate. SF and CS probably don't matter that much, but IBB could be interesting.
last_stint_grouped_by_year <- ungroup(only_last_stint) %>% group_by(yearID)
summarise_all(last_stint_grouped_by_year, funs(sum(is.na(.))))
```

# Go back to postseason, add OPS and see how much we lose to NA. (Should be none!)
# Do the join finally, see how many rows we have if we filter by > 1954, when we have everything, and also by > 1938, when we lose GIDP, then >1912 when we'd lose SO.

```{r}
#aug_bat_no_na = as_tibble(inner_join(Batting, BattingPost, by=c("playerID", "yearID")) %>% na.omit())
```
